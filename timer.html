<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Timer – Fin des votes</title>

  <style>
    /* Corps entièrement centré pour que le “card” soit centré dans l’iframe */
    body {
      margin: 0;
      padding: 0;
      font-family: Roboto, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: transparent; /* Laisse transparaître l’arrière-plan parent */
    }

    /* Carte blanche autour du timer */
    #timerCard {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 1.5em 2em;
      text-align: center;
      max-width: 400px;
      width: 90%;
    }

    /* Titre principal avec l’icône ⏳ */
    #timerCard h2 {
      margin: 0;
      font-size: 1.3rem;
      color: #333333;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5em;
    }
    #timerCard h2 .icon {
      font-size: 1.4rem;
      color: #1976d2;
    }

    /* Ligne du décompte (texte bleu) */
    #countdown {
      margin-top: 0.75em;
      font-size: 1.5rem;
      font-weight: 500;
      color: #1976d2;
      letter-spacing: 0.02em;
    }

    /* Style pour le message “Impossible de charger” (en rouge) */
    #countdown.error {
      color: #d32f2f;
    }
  </style>
</head>
<body>
  <div id="timerCard">
    <h2>
      <span class="icon">⏳</span>
      <span>Fin des votes dans :</span>
    </h2>
    <div id="countdown">Chargement…</div>
  </div>

  <script>
    // ───────────────────────────────────────────────────────────────────
    //             URL de votre Web App Apps Script (à adapter)
    // ───────────────────────────────────────────────────────────────────
    //
    // Remplacez ci-dessous par votre propre URL “déployée” (le même que celui
    // que vous mettiez auparavant dans l’iframe pour page=timer, mais ici
    // on supposera que votre Apps Script supporte une requête GET qui renvoie
    // { "target": "2025-06-14T18:00:00.000Z" } en JSON)
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxrcQVBEjTMNyx0maHhCzpLMacF3J9sgE4qnD8XF8Km2t-qeHeIIk7DfTh_GbuQHEi1Kg/exec';

    // ───────────────────────────────────────────────────────────────────
    // Fonction qui envoie au parent la hauteur du document pour ajuster l’iframe
    // ───────────────────────────────────────────────────────────────────
    function notifyHeight() {
      window.parent.postMessage({
        type: 'resize',
        page: 'timer',
        height: document.body.scrollHeight
      }, '*');
    }

    // Dès que la page est chargée, on notifie le parent (méthode “once”)
    window.addEventListener('load', notifyHeight);

    // Référence à l’élément qui affichera le décompte ou les messages d’erreur
    const countdownEl = document.getElementById('countdown');
    let intervalId = null;

    // ───────────────────────────────────────────────────────────────────
    // 1) On appelle l’Apps Script : on attend un JSON du type { "target": "<ISO>" }
    //    Si l’Apps Script ne renvoie pas un JSON valide ou s’il y a erreur réseau,
    //    on passe en mode “Impossible de charger”.
    // ───────────────────────────────────────────────────────────────────
    fetch(`${SCRIPT_URL}?action=getCountdownTarget`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Réponse non OK');
        }
        return response.json();
      })
      .then(data => {
        // data.target doit être une chaîne ISO (ex. "2025-06-14T18:00:00.000Z")
        if (!data || !data.target) {
          // Cas où l’on n’a pas configuré de target
          countdownEl.textContent = 'Non configuré';
          notifyHeight();
          return;
        }
        startCountdown(data.target);
      })
      .catch(err => {
        console.error('Erreur fetch timer:', err);
        countdownEl.textContent = 'Impossible de charger';
        countdownEl.classList.add('error');
        notifyHeight();
      });

    // ───────────────────────────────────────────────────────────────────
    // 2) Fonction startCountdown(iso) : lance l’intervalle qui met à jour chaque seconde
    // ───────────────────────────────────────────────────────────────────
    function startCountdown(isoString) {
      const targetTime = new Date(isoString).getTime();

      function update() {
        const now   = Date.now();
        const diff  = targetTime - now;

        if (diff > 0) {
          // On calcule jours / heures / minutes / secondes
          const jours    = Math.floor(diff / 86400000);
          const heures   = Math.floor((diff % 86400000) / 3600000);
          const minutes  = Math.floor((diff % 3600000) / 60000);
          const secondes = Math.floor((diff % 60000) / 1000);

          // On assemble la chaîne “Xj Yh Zm Ws”
          countdownEl.textContent = 
            `${jours}j ${heures}h ${minutes}m ${secondes}s`;
        } else {
          // Le décompte est terminé
          clearInterval(intervalId);
          countdownEl.textContent = 'Le vote est terminé !';
          countdownEl.classList.add('error');
          // On prévient également le parent que le timer est fini
          window.parent.postMessage({ type: 'timerEnded' }, '*');
        }

        // À chaque tick, on notifie la hauteur (au cas où le texte change de taille)
        notifyHeight();
      }

      // On lance immédiatement, puis toutes les secondes
      update();
      intervalId = setInterval(update, 1000);
    }
  </script>
</body>
</html>
