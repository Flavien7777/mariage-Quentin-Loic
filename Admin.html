<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Admin – Mariage</title>
  <style>
    body, html { margin:0; padding:0; font-family:Roboto,sans-serif; }
    .container { max-width:400px; margin:2em auto; padding:1em; }
    .hidden { display:none; }
    label { display:block; margin:0.5em 0 0.2em; }
    input, button, textarea {
      width:100%; padding:0.5em; margin-bottom:1em;
      border:1px solid #ccc; border-radius:4px;
      box-sizing:border-box;
    }
    button { background:#1976d2; color:#fff; border:none; cursor:pointer; }
    button:hover { background:#0f5ca8; }
    #msg { margin-top:1em; font-weight:bold; }
  </style>
</head>
<body>
  <div class="container">

    <!-- 1) Login -->
    <div id="loginBox">
      <h2>Admin Login</h2>
      <label>Mot de passe :</label>
      <input type="password" id="adminPwd">
      <button onclick="doLogin()">Se connecter</button>
      <div id="msg"></div>
    </div>

    <!-- 2) Interface admin -->
    <div id="adminUI" class="hidden">
      <h2>Administration</h2>

      <!-- Définir la date/heure cible -->
      <label>Date/Heure du début du vote :</label>
      <input type="datetime-local" id="targetInput">
      <button onclick="saveTarget()">Enregistrer</button>

      <hr>

      <!-- Résultats en direct -->
      <h3>Résultats actuels</h3>
      <button onclick="refreshResults()">Rafraîchir</button>
      <textarea id="resArea" rows="8" readonly></textarea>

      <hr>

      <button onclick="google.script.host.close()">Fermer</button>
    </div>

  </div>

  <script>
    function doLogin() {
      const pwd = document.getElementById('adminPwd').value;
      google.script.run
        .withSuccessHandler(ok=>{
          if(ok) {
            document.getElementById('loginBox').classList.add('hidden');
            document.getElementById('adminUI').classList.remove('hidden');
            loadTarget();
            refreshResults();
          } else {
            document.getElementById('msg').textContent = '❌ Mot de passe incorrect';
          }
        })
        .checkAdmin(pwd);
    }

    function loadTarget() {
      google.script.run
        .withSuccessHandler(iso=>{
          if(iso) document.getElementById('targetInput').value = iso.slice(0,16);
        })
        .getCountdownTarget();
    }

    function saveTarget() {
      const dt = document.getElementById('targetInput').value;
      if (!dt) return;
      // envoie en ISO
      google.script.run
        .withSuccessHandler(_=>{
          alert('Date cible enregistrée !');
        })
        .setCountdownTarget(new Date(dt).toISOString());
    }

    function refreshResults() {
      google.script.run
        .withSuccessHandler(data=>{
          // affichage JSON simple
          document.getElementById('resArea').value =
            JSON.stringify(data, null, 2);
        })
        .getVoteResults();
    }
  </script>
</body>
</html>
