<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Votez pour vos photos</title>
  <style>
    html, body {
      margin:0; padding:0; height:100%; overflow-y:auto;
      font-family:Roboto,sans-serif; background:transparent;
    }
    .card {
      background:#fff; margin:1em auto; padding:24px;
      border-radius:12px;
      box-shadow:0 1px 3px rgba(0,0,0,0.12),
                 0 1px 2px rgba(0,0,0,0.24);
      width:90%; max-width:360px; text-align:center;
    }
    h2 { margin-bottom:16px; color:#333; font-size:1.2rem; }
    h2 span { display:block; }
    .category {
      margin:1em 0; padding:1em; background:#f9f9f9; border-radius:8px;
    }
    .category h3 {
      margin-bottom:8px; color:#333; font-size:1rem;
    }
    .category img {
      width:100%; aspect-ratio:1/1; object-fit:cover;
      border-radius:4px; margin-bottom:8px; display:block;
    }
    .category button {
      width:100%; padding:.8em; background:#1976d2; color:#fff;
      border:none; border-radius:6px; cursor:pointer;
      transition:background .2s; font-size:.9rem;
    }
    .category button:hover { background:#0f5ca8; }

    #voter {
      width:90%; max-width:360px; padding:.8em; margin:1em auto;
      border:1px solid #ccc; border-radius:4px; font-size:.9rem;
    }
    #submitVote, #resetVote {
      width:90%; max-width:360px; padding:.8em; margin-bottom:1em;
      border:none; border-radius:6px; cursor:pointer;
      transition:background .2s; font-size:1rem;
    }
    #submitVote {
      background:#1976d2; color:#fff;
    }
    #submitVote:hover { background:#0f5ca8; }
    #resetVote {
      background:#d32f2f; color:#fff; display:none;
    }
    #resetVote:hover { background:#a52716; }

    #voteMsg {
      min-height:1.2em; font-size:.95rem; margin-bottom:1em;
    }

    /* Overlay de s√©lection */
    #modalOverlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.7); display:none;
      align-items:center; justify-content:center;
      padding:1em; box-sizing:border-box; z-index:1000;
    }
    #modal {
      background:#fff; border-radius:8px;
      width:90%; max-width:360px; max-height:90vh;
      display:flex; flex-direction:column; overflow:hidden;
    }
    #photoGrid {
      flex:1; overflow:auto; display:grid;
      grid-template-columns:repeat(auto-fit,minmax(80px,1fr));
      gap:.5em; padding:.5em;
    }
    #photoGrid img {
      width:100%; aspect-ratio:1/1; object-fit:cover;
      border-radius:4px; cursor:pointer;
      border:2px solid transparent; transition:border-color .2s;
    }
    #photoGrid img:hover { border-color:#1976d2; }
    .gallery-button {
      width:80%; max-width:200px; padding:.6em; margin:.5em auto;
      background:#1976d2; color:#fff; border:none; border-radius:6px;
      cursor:pointer; transition:background .2s;
    }
    .gallery-button:hover { background:#0f5ca8; }

    /* Lightbox */
    #overlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.85); display:none;
      align-items:center; justify-content:center;
      flex-direction:column; padding:1em; box-sizing:border-box;
      z-index:1001; touch-action: pan-y pinch-zoom;
    }
    #overlay img {
      max-width:90%; max-height:60%; border-radius:8px;
      box-shadow:0 4px 20px rgba(0,0,0,0.5);
      transition:transform .3s ease; will-change:transform;
      cursor:grab;
    }
    #overlay img.zoomed { cursor:zoom-out; }
    #overlay .close {
      position:absolute; top:16px; right:16px;
      background:#fff; border:none; border-radius:50%;
      width:32px; height:32px; font-size:1.2rem; cursor:pointer;
      z-index:2;
    }
    #overlay .select-button {
      width:80%; max-width:360px; padding:.6em; margin-top:.5em;
      background:#1976d2; color:#fff; border:none; border-radius:6px;
      cursor:pointer; transition:background .2s; z-index:2;
    }
    #overlay .select-button:hover { background:#0f5ca8; }

    /* Section R√©sultats */
    #resultsSection {
      display:none; width:90%; max-width:360px; margin:1em auto;
      font-family:Roboto,sans-serif; text-align:center;
    }
    #resultsSection h2 {
      margin-bottom:16px; color:#333; font-size:1.2rem;
    }
    .winner {
      margin-bottom:1.5em;
    }
    .winner h3 {
      margin-bottom:.5em; color:#1976d2;
    }
    .winner img {
      width:100%; aspect-ratio:1/1; object-fit:cover;
      border-radius:8px; margin-bottom:.5em;
    }
    .winner .count {
      font-size:1rem; color:#333;
    }
  </style>
</head>
<body>

  <!-- SECTION VOTE -->
  <div id="voteSection">
    <div class="card">
      <h2>üó≥Ô∏è Votez pour<br><span>vos photos pr√©f√©r√©es</span></h2>
      <div class="category" data-cat="romantic">
        <h3>La plus romantique</h3>
        <img id="thumb-romantic" style="display:none">
        <button onclick="openGallery('romantic')">Choisir</button>
      </div>
      <div class="category" data-cat="funny">
        <h3>La plus dr√¥le</h3>
        <img id="thumb-funny" style="display:none">
        <button onclick="openGallery('funny')">Choisir</button>
      </div>
      <div class="category" data-cat="original">
        <h3>La plus originale</h3>
        <img id="thumb-original" style="display:none">
        <button onclick="openGallery('original')">Choisir</button>
      </div>

      <input type="text" id="voter" placeholder="Votre nom (facultatif)">
      <button id="submitVote">Envoyer mon vote</button>
      <button id="resetVote">R√©initialiser mon vote</button>
      <div id="voteMsg"></div>
    </div>

    <div id="modalOverlay">
      <div id="modal">
        <div id="photoGrid"></div>
        <button class="gallery-button" onclick="closeGallery()">Annuler</button>
      </div>
    </div>

    <div id="overlay">
      <button class="close" onclick="closeLightbox()">√ó</button>
      <img id="lb-img" src="">
      <button class="select-button" onclick="selectPhoto()">S√©lectionner</button>
    </div>
  </div>

  <!-- SECTION R√âSULTATS -->
  <div id="resultsSection">
    <h2>üèÜ R√©sultats des votes</h2>
    <div id="winnersContainer"></div>
  </div>

  <script>
    let photos=[], currentCat='', currentIndex=0;
    let scale=1, startDist=0, panX=0, panY=0,
        panStartX=0, panStartY=0, swipeStartX=null;

    // 1) Choix de mode selon timer
    google.script.run.withSuccessHandler(checkMode)
      .getCountdownTarget();
    function checkMode(iso) {
      if (iso) {
        const targetTs = new Date(iso).getTime();
        const nowTs    = Date.now();
        if (nowTs > targetTs) {
          // Si la date est d√©pass√©e, on affiche directement les r√©sultats
          showResults();
        } else {
          // Sinon on initialise le vote,
          initVote();
          // et on planifie la bascule automatique lorsque le timer atteint 0
          setTimeout(showResults, targetTs - nowTs + 100);
        }
      } else {
        // Pas de date configur√©e : mode vote par d√©faut
        initVote();
      }
    }

    // 2A) Init vote + restoration UI
    function initVote(){
      document.getElementById('voteSection').style.display='block';
      document.getElementById('resultsSection').style.display='none';
      reloadPhotos();
      manageVoteState();
    }

    // 2B) Affiche les r√©sultats
    function showResults(){
      document.getElementById('voteSection').style.display='none';
      document.getElementById('resultsSection').style.display='block';
      google.script.run.withSuccessHandler(renderResults)
        .getVoteResults();
    }

    // 3) G√®re bouton envoyer/r√©init et restaure vignettes
    function manageVoteState(){
      const uuid = localStorage.getItem('voteUuid');
      document.getElementById('submitVote').style.display = uuid?'none':'block';
      document.getElementById('resetVote').style.display = uuid?'block':'none';
      document.getElementById('voteMsg').textContent = uuid
        ? '‚úÖ Vous avez d√©j√† vot√©.'
        : '';
      // restaure vignettes sur page reload
      const sel = JSON.parse(localStorage.getItem('voteSelection')||'{}');
      for(let cat of ['romantic','funny','original']){
        if(sel[cat] && photos.length){
          const p = photos.find(x=>x.id===sel[cat]);
          if(p){
            const imgEl = document.getElementById(`thumb-${cat}`);
            imgEl.src = p.url;
            imgEl.style.display='block';
          }
        }
      }
    }

    // 4) Envoi du vote
    document.getElementById('submitVote').onclick=()=>{
      const sel = JSON.parse(localStorage.getItem('voteSelection')||'{}');
      const msg = document.getElementById('voteMsg');
      if(!sel.romantic||!sel.funny||!sel.original){
        msg.textContent='üö´ Choisissez une photo pour chaque cat√©gorie.';
        return;
      }
      google.script.run
        .withSuccessHandler(uuid=>{
          localStorage.setItem('voteUuid',uuid);
          document.getElementById('voteMsg').textContent='‚úÖ Vote enregistr√© !';
          manageVoteState();
        })
        .recordVote({
          category:'multi',
          photoId:JSON.stringify(sel),
          voterName:document.getElementById('voter').value.trim()
        });
    };

    // 5) R√©initialisation : n‚Äôefface QUE l‚ÄôUUID, conserve la s√©lection
    document.getElementById('resetVote').onclick=()=>{
      const uuid = localStorage.getItem('voteUuid');
      if(!uuid) return manageVoteState();
      google.script.run
        .withSuccessHandler(()=>{
          localStorage.removeItem('voteUuid');
          document.getElementById('voteMsg').textContent=
            'Vous pouvez modifier votre/vos cat√©gorie(s) et renvoyer.';
          manageVoteState();
        })
        .withFailureHandler(err=>{
          document.getElementById('voteMsg').textContent=
            '‚ùå Impossible de r√©initialiser : '+err.message;
        })
        .deleteVote(uuid);
    };

    // 6) Rendu des r√©sultats
    function renderResults(res){
      const c=document.getElementById('winnersContainer');
      c.innerHTML='';
      for(let cat of ['romantic','funny','original']){
        const counts=res[cat];
        let maxId=null, maxCount=-1;
        for(let id in counts){
          if(counts[id]>maxCount){
            maxCount=counts[id]; maxId=id;
          }
        }
        const div=document.createElement('div');
        div.className='winner';
        div.innerHTML=`
          <h3>${
            {romantic:'La plus romantique',
             funny:'La plus dr√¥le',
             original:'La plus originale'}[cat]
          }</h3>
          <img src="https://drive.google.com/thumbnail?sz=w400&id=${maxId}">
          <div class="count">${maxCount} vote(s)</div>
        `;
        c.appendChild(div);
      }
    }

    // 7) Galerie, lightbox, swipe, zoom, selectPhoto (inchang√©)
    function reloadPhotos(){
      google.script.run.withSuccessHandler(l=>{
        photos=l;
        // restauration des vignettes apr√®s chargement photos
        manageVoteState();
      }).getPhotoList();
    }
    function openGallery(cat){
      currentCat=cat;
      const g=document.getElementById('photoGrid');
      g.innerHTML='';
      photos.forEach((p,i)=>{
        const img=document.createElement('img');
        img.src=p.url; img.alt=p.name;
        img.onclick=()=>openLightbox(i);
        g.appendChild(img);
      });
      document.getElementById('modalOverlay').style.display='flex';
    }
    function closeGallery(){
      document.getElementById('modalOverlay').style.display='none';
    }
    function openLightbox(i){
      currentIndex=i; preload(i-1); preload(i+1);
      scale=1; panX=panY=0;
      const imgEl=document.getElementById('lb-img');
      imgEl.src=photos[i].url.replace(/sz=w400/,'sz=w4096');
      imgEl.style.transform='translate(0,0) scale(1)';
      document.getElementById('overlay').style.display='flex';
    }
    function closeLightbox(){
      document.getElementById('overlay').style.display='none';
    }
    function preload(i){
      if(i<0) i=photos.length-1;
      if(i>=photos.length) i=0;
      new Image().src=photos[i].url.replace(/sz=w400/,'sz=w4096');
    }
    function updateTransform(){
      document.getElementById('lb-img').style.transform=
        `translate(${panX}px,${panY}px) scale(${scale})`;
    }
    const overlay=document.getElementById('overlay');
    overlay.addEventListener('touchstart',e=>{
      if(e.touches.length===2){
        const dx=e.touches[0].pageX-e.touches[1].pageX;
        const dy=e.touches[0].pageY-e.touches[1].pageY;
        startDist=Math.hypot(dx,dy);
      } else if(e.touches.length===1){
        if(scale>1){
          panStartX=e.touches[0].pageX-panX;
          panStartY=e.touches[0].pageY-panY;
        } else {
          swipeStartX=e.touches[0].screenX;
        }
      }
    },{passive:false});
    overlay.addEventListener('touchmove',e=>{
      if(e.touches.length===2){
        const dx=e.touches[0].pageX-e.touches[1].pageX;
        const dy=e.touches[0].pageY-e.touches[1].pageY;
        const dist=Math.hypot(dx,dy);
        scale*=dist/startDist; startDist=dist;
        scale=Math.max(1,Math.min(4,scale));
        if(scale===1){panX=panY=0;}
        updateTransform(); e.preventDefault();
      } else if(e.touches.length===1&&scale>1){
        panX=e.touches[0].pageX-panStartX;
        panY=e.touches[0].pageY-panStartY;
        updateTransform(); e.preventDefault();
      }
    },{passive:false});
    overlay.addEventListener('touchend',e=>{
      if(scale===1 && swipeStartX!==null){
        const diff=e.changedTouches[0].screenX-swipeStartX;
        if(diff>30) prevPhoto(); else if(diff<-30) nextPhoto();
      }
      swipeStartX=null;
    });
    document.getElementById('lb-img').addEventListener('click',e=>{
      if(scale>1){scale=1;panX=panY=0;updateTransform();}
    });
    document.addEventListener('keydown',e=>{
      if(e.key==='ArrowLeft') prevPhoto();
      if(e.key==='ArrowRight') nextPhoto();
      if(e.key==='Escape') closeLightbox();
    });
    function prevPhoto(){
      currentIndex=currentIndex>0?currentIndex-1:photos.length-1;
      openLightbox(currentIndex);
    }
    function nextPhoto(){
      currentIndex=currentIndex<photos.length-1?currentIndex+1:0;
      openLightbox(currentIndex);
    }
    function selectPhoto(){
      const p=photos[currentIndex];
      const sel=JSON.parse(localStorage.getItem('voteSelection')||'{}');
      sel[currentCat]=p.id;
      localStorage.setItem('voteSelection',JSON.stringify(sel));
      const thumb=document.getElementById(`thumb-${currentCat}`);
      thumb.src=p.url; thumb.style.display='block';
      closeLightbox(); closeGallery();
    }
  </script>
</body>
</html>
