<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Galerie des photos</title>
  <style>
    html, body {
      margin:0; padding:0; height:100%; overflow:hidden;
      display:flex; flex-direction:column;
      background:#f9f9f9; font-family:Roboto,sans-serif;
    }
    #gallery {
      flex:1; display:grid; grid-gap:8px;
      grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      overflow:auto; padding:8px; box-sizing:border-box;
    }
    #gallery img {
      width:100%; border-radius:4px;
      object-fit:cover; cursor:pointer;
      transition:transform .2s;
    }
    #gallery img:hover { transform:scale(1.02); }

    /* Overlay plein écran dans l’iframe */
    #overlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.8);
      display:none; flex-direction:column;
      align-items:center; justify-content:center;
      padding:1em; box-sizing:border-box; z-index:1000;
      touch-action: pan-y pinch-zoom;
    }
    #overlay .close {
      position:absolute; top:16px; right:16px;
      width:32px; height:32px; background:#fff;
      border:none; border-radius:50%; font-size:1.2rem;
      line-height:32px; text-align:center;
      cursor:pointer; z-index:1000;
    }
    #overlay-img {
      max-width:90%; max-height:60%;
      border-radius:8px;
      box-shadow:0 4px 20px rgba(0,0,0,0.5);
      transition:transform .3s ease, opacity .3s ease;
      opacity:1; will-change:transform;
      cursor:grab;
    }
    #openFullBtn {
      margin-top:0.8em;
      padding:0.8em 1.2em;
      background:#1976d2; color:#fff;
      border:none; border-radius:6px;
      cursor:pointer; transition:background .2s;
      font-size:0.95rem;
    }
    #openFullBtn:hover {
      background:#0f5ca8;
    }
  </style>
</head>
<body>
  <div id="gallery"></div>

  <div id="overlay">
    <button class="close" onclick="closeOverlay()">×</button>
    <img id="overlay-img" src="">
    <button id="openFullBtn">Ouvrir en grand</button>
  </div>

  <script>
    let photos = [], currentIndex = 0;
    let startDist=0, currentScale=1;
    let startX=0, startY=0, panX=0, panY=0, isPanning=false;
    let swipeStartX=null;

    const galleryEl = document.getElementById('gallery');
    const overlay   = document.getElementById('overlay');
    const imgEl     = document.getElementById('overlay-img');
    const fullBtn   = document.getElementById('openFullBtn');

    // Charge les vignettes
    function loadGallery() {
      google.script.run.withSuccessHandler(list => {
        photos = list;
        galleryEl.innerHTML = '';
        list.forEach((p,i) => {
          const thumb = document.createElement('img');
          thumb.src     = 'https://drive.google.com/thumbnail?sz=w400&id=' + p.id;
          thumb.alt     = p.name;
          thumb.loading = 'lazy';
          thumb.onclick = () => openOverlay(i);
          galleryEl.appendChild(thumb);
        });
      }).getPhotoList();
    }

    // Ouvre overlay et configure le bouton plein écran
    function openOverlay(i) {
      window.scrollTo(0,0);
      currentIndex = i;
      currentScale = 1; panX=panY=0;
      showImage(i);
      overlay.style.display = 'flex';

      // configure le bouton pour ouvrir la vraie URL plein format
      fullBtn.onclick = () => {
        const id = photos[currentIndex].id;
        // open native file view
        window.open(
          'https://drive.google.com/uc?export=view&id=' + id,
          '_blank'
        );
      };
    }

    // Affiche l’image HD dans l’overlay
    function showImage(i) {
      imgEl.style.opacity = 0;
      preload(i-1); preload(i+1);
      imgEl.onload = ()=> imgEl.style.opacity = 1;
      imgEl.src = 'https://drive.google.com/thumbnail?sz=w2048&id=' + photos[i].id;
      updateTransform();
    }
    function preload(i) {
      if (!photos.length) return;
      if (i<0) i = photos.length-1;
      if (i>=photos.length) i = 0;
      new Image().src = 'https://drive.google.com/thumbnail?sz=w2048&id=' + photos[i].id;
    }

    // Ferme overlay
    function closeOverlay() {
      overlay.style.display = 'none';
    }

    // Applique translate & scale
    function updateTransform() {
      imgEl.style.transform = `translate(${panX}px,${panY}px) scale(${currentScale})`;
    }

    // Gestes tactiles: pinch / pan / swipe
    overlay.addEventListener('touchstart', e => {
      if (e.touches.length===2) {
        const dx = e.touches[0].pageX - e.touches[1].pageX;
        const dy = e.touches[0].pageY - e.touches[1].pageY;
        startDist = Math.hypot(dx,dy);
      } else if (e.touches.length===1) {
        if (currentScale>1) {
          isPanning = true;
          startX = e.touches[0].pageX - panX;
          startY = e.touches[0].pageY - panY;
        } else {
          swipeStartX = e.changedTouches[0].screenX;
        }
      }
    }, { passive:false });

    overlay.addEventListener('touchmove', e => {
      if (e.touches.length===2) {
        const dx = e.touches[0].pageX - e.touches[1].pageX;
        const dy = e.touches[0].pageY - e.touches[1].pageY;
        const dist = Math.hypot(dx,dy);
        currentScale *= dist/startDist;
        startDist = dist;
        currentScale = Math.max(1, Math.min(4, currentScale));
        if (currentScale===1) panX=panY=0;
        updateTransform();
        e.preventDefault();
      } else if (e.touches.length===1 && isPanning) {
        panX = e.touches[0].pageX - startX;
        panY = e.touches[0].pageY - startY;
        updateTransform();
        e.preventDefault();
      }
    }, { passive:false });

    overlay.addEventListener('touchend', e => {
      if (isPanning) {
        isPanning = false;
      } else if (swipeStartX!==null && currentScale===1) {
        const diff = e.changedTouches[0].screenX - swipeStartX;
        if (diff>50) openOverlay((currentIndex-1+photos.length)%photos.length);
        else if (diff<-50) openOverlay((currentIndex+1)%photos.length);
      }
      swipeStartX = null;
    });

    // Unzoom au clic simple
    imgEl.addEventListener('click', e => {
      e.stopPropagation();
      if (currentScale>1) {
        currentScale=1; panX=panY=0;
        updateTransform();
      }
    });

    // Clic hors image ou Échap ferme
    overlay.addEventListener('click', e => {
      if (e.target===overlay) closeOverlay();
    });
    document.addEventListener('keydown', e => {
      if (e.key==='Escape') closeOverlay();
    });

    // Démarrage
    loadGallery();
  </script>
</body>
</html>
